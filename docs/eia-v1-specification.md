# EIA (Efficient Image Archive) バージョン1 仕様書

## 概要

本文書は、画像シーケンスの効率的な保存と送信のために設計されたバイナリコンテナフォーマットである EIA (Efficient Image Archive) バージョン1 フォーマットを定義します。EIA v1は、差分エンコーディングとLZ4圧縮により、フレーム間の差異が最小限の画像シーケンスに対して大幅な圧縮効果を提供します。

## 1. はじめに

### 1.1 目的

EIA v1フォーマットは、特にスライドプレゼンテーションやUIスクリーンショットのようなフレーム間の差異が最小限の画像シーケンスを効率的に保存するために設計されています。このフォーマットは以下の手法により圧縮を実現します：

- クロップ領域の差分エンコーディング
- 画像データのLZ4圧縮
- 高速アクセス向けの最適化されたバイナリ構造

### 1.2 用語

本文書における「しなければならない（MUST）」、「してはならない（MUST NOT）」、「要求される（REQUIRED）」、「するものとする（SHALL）」、「しないものとする（SHALL NOT）」、「すべきである（SHOULD）」、「すべきでない（SHOULD NOT）」、「推奨される（RECOMMENDED）」、「してもよい（MAY）」、「選択的（OPTIONAL）」は、RFC 2119に記載されているとおりに解釈されるものとします。

### 1.3 フォーマット識別子

EIA v1ファイルは以下により識別されます：
- タイプ識別子: `"eia"`
- バージョン番号: `1`
- 圧縮方式: `"lz4"`

## 2. ファイル構造

### 2.1 全体構造

EIA v1ファイルは以下で構成されます：

```
[ヘッダー][マニフェスト][圧縮データブロック...]
```

### 2.2 ヘッダー形式

ファイルヘッダーは、リテラル文字列 `"EIA^"` で始まり、続いてJSONエンコードされたマニフェスト、そして `"$"` で終端されなければなりません（MUST）：

```
EIA^{manifest_json}$
```

ここで `{manifest_json}` は JSONエンコードされた EIAManifestV1 オブジェクトです。

### 2.3 マニフェスト構造

マニフェストは以下の必須フィールドを持つJSONオブジェクトです：

```typescript
type EIAManifestV1 = {
  t: "eia";           // タイプ識別子（"eia"でなければならない）
  c: "lz4";           // 圧縮方式（"lz4"でなければならない）
  v: 1;               // バージョン番号（1でなければならない）
  f: string[];        // 機能配列
  e: EIAExtension[];  // 拡張配列
  i: EIAFileV1[];     // アイテム配列
}
```

#### 2.3.1 機能配列

機能配列（`f`）は、`"Format:{format_name}"` 形式の文字列を含まなければなりません（MUST）。`{format_name}` はアーカイブで使用されるサポートされたテクスチャフォーマットの一つです。

#### 2.3.2 拡張配列

拡張配列（`e`）は、サポートされた拡張識別子を含まなければなりません（MUST）。現在サポートされている拡張：
- `"note"`: 個別アイテムのテキストアノテーション

#### 2.3.3 アイテム配列

アイテム配列（`i`）は、アーカイブ内の各画像を記述する EIAFileV1 オブジェクトを含まなければなりません（MUST）。

## 3. ファイルタイプ

### 3.1 マスターファイル

マスターファイルは、依存関係のない完全な画像データを含みます：

```typescript
type EIAFileV1Master = {
  t: "m";                        // タイプ（"m"でなければならない）
  n: string;                     // 名前/識別子
  f: TTextureFormat;             // フォーマット識別子
  w: number;                     // 幅（ピクセル）
  h: number;                     // 高さ（ピクセル）
  s: number;                     // データセクション内の開始オフセット
  l: number;                     // 圧縮データ長
  u: number;                     // 非圧縮データサイズ
  e?: EIAExtensionObject;        // オプション拡張
}
```

### 3.2 クロップファイル

クロップファイルは、ベース画像を参照する差分データを含みます：

```typescript
type EIAFileV1Cropped = {
  t: "c";                        // タイプ（"c"でなければならない）
  b: string;                     // ベースファイル名参照
  n: string;                     // 名前/識別子
  f: TTextureFormat;             // フォーマット識別子
  w: number;                     // 元の幅（ピクセル）
  h: number;                     // 元の高さ（ピクセル）
  s: number;                     // データセクション内の開始オフセット
  l: number;                     // 圧縮データ長
  u: number;                     // 非圧縮データサイズ
  e?: EIAExtensionObject;        // オプション拡張
  r: EIAFileV1CroppedPart[];     // 矩形配列
}
```

#### 3.2.1 クロップパーツ

各クロップパーツは、ベース画像と異なる矩形領域を記述します：

```typescript
type EIAFileV1CroppedPart = {
  x: number;          // ベース画像内のX座標
  y: number;          // ベース画像内のY座標
  w: number;          // 幅（ピクセル）
  h: number;          // 高さ（ピクセル）
  s: number;          // ファイル内データの開始オフセット
  l: number;          // 長さ（バイト）
}
```

## 4. データセクション

### 4.1 構造

データセクションはヘッダーの直後に続き、LZ4圧縮された画像データブロックを含みます。各ファイルのデータは単一の圧縮ブロックとして保存されます。

### 4.2 圧縮

- すべての画像データはLZ4を使用して圧縮されなければなりません（MUST）
- 各ファイルのデータは独立して圧縮されます
- クロップファイルは圧縮前に矩形データを連結します

### 4.3 データレイアウト

マスターファイルの場合：
- 圧縮ブロックは完全な画像データを含みます

クロップファイルの場合：
- 矩形データは `r` 配列で指定された順序で連結されます
- 連結されたデータは単一ブロックとしてLZ4圧縮されます
- `EIAFileV1CroppedPart.s` のオフセットは、非圧縮連結データ内の位置を参照します

## 5. サポートされるフォーマット

### 5.1 テクスチャフォーマット

現在サポートされているテクスチャフォーマット：
- `"RGB24"`: 24ビットRGB（ピクセルあたり3バイト）
- `"RGBA32"`: 32ビットRGBA（ピクセルあたり4バイト）

### 5.2 フォーマット要件

- ピクセルデータは指定されたフォーマットで保存されなければなりません（MUST）
- RGB24フォーマットはRGB順で1チャンネルあたり8ビットを使用しなければなりません（MUST）
- RGBA32フォーマットはRGBA順で1チャンネルあたり8ビットを使用しなければなりません（MUST）

## 6. 拡張

### 6.1 拡張オブジェクト

拡張はオプションの `e` フィールドに保存されます：

```typescript
type EIAExtensionObject = {
  note?: string;                 // オプションテキストアノテーション
  [key: string]: string;         // 追加の拡張
}
```

### 6.2 ノート拡張

`note` 拡張は画像のUTF-8エンコードされたテキストアノテーションを含んでもよいです（MAY）。

## 7. 処理ガイドライン

### 7.1 エンコーディング

エンコーダーは以下をすべきです（SHOULD）：
- 変化が最小限のシーケンスに差分エンコーディングを使用する
- 圧縮とランダムアクセスのバランスを取るためキーフレーム間隔を設定する
- 冗長データを最小化するため矩形配置を最適化する

### 7.2 デコーディング

デコーダーは以下をしなければなりません（MUST）：
- 処理前にヘッダー形式を検証する
- バージョン互換性をチェックする
- LZ4を使用してデータを展開する
- ベース画像に矩形を適用してクロップ画像を再構築する

### 7.3 エラーハンドリング

実装は以下を処理しなければなりません（MUST）：
- 無効なヘッダー形式
- サポートされていないバージョン
- 圧縮エラー
- 欠損ベースファイル参照

## 8. セキュリティ考慮事項

### 8.1 入力検証

実装は以下を検証しなければなりません（MUST）：
- ヘッダー形式と長さ
- JSONマニフェスト構造
- バッファオーバーフローを防ぐためのオフセットと長さ値
- 圧縮爆弾を検出するための圧縮率

### 8.2 リソース制限

実装は以下について合理的な制限を設けるべきです（SHOULD）：
- マニフェストサイズ
- ファイル数
- 画像サイズ
- 非圧縮データサイズ

## 9. 例

### 9.1 最小限のマスターファイル

```json
{
  "t": "eia",
  "c": "lz4",
  "v": 1,
  "f": ["Format:RGB24"],
  "e": ["note"],
  "i": [{
    "t": "m",
    "n": "0",
    "f": "RGB24",
    "w": 1920,
    "h": 1080,
    "s": 0,
    "l": 256000,
    "u": 6220800
  }]
}
```

### 9.2 ベース参照付きクロップファイル

```json
{
  "t": "eia",
  "c": "lz4", 
  "v": 1,
  "f": ["Format:RGB24"],
  "e": ["note"],
  "i": [{
    "t": "c",
    "b": "0",
    "n": "1",
    "f": "RGB24",
    "w": 1920,
    "h": 1080,
    "s": 0,
    "l": 5000,
    "u": 15000,
    "r": [{
      "x": 100,
      "y": 200,
      "w": 50,
      "h": 100,
      "s": 0,
      "l": 15000
    }]
  }]
}
```

## 10. 参考文献

- RFC 2119: RFCで要件レベルを示すために使用するキーワード
- LZ4圧縮アルゴリズム
- S3TC/DXT1テクスチャ圧縮仕様

## 付録A: 型定義

完全なTypeScript型定義については、ソースコードを参照してください：
- `src/_types/eia/v1.ts`: EIA v1コア型
- `src/_types/text-zip/formats.ts`: テクスチャフォーマット定義
